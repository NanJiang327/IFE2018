<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>我是精明的小卖家（一)</title>
	<style>
		.box{
			width: 800px;
			margin: 0 auto;
			padding: 10px;
			border: 1px solid seagreen;
		}

		.sub-title{
			font-size: 20px;
		}

		table.dataintable {
			margin-top:15px;
			border-collapse:collapse;
			border:1px solid #aaa;
			width:100%;
		}

		table.dataintable th {
			vertical-align:baseline;
			padding:5px 15px 5px 6px;
			background-color:#3F3F3F;
			border:1px solid #3F3F3F;
			text-align:left;
			color:#fff;
		}

		table.dataintable td {
			vertical-align:text-top;
			padding:6px 15px 6px 6px;
			border:1px solid #aaa;
		}

		table.dataintable tr:nth-child(odd) {
			background-color:#F5F5F5;
		}

		table.dataintable tr:nth-child(even) {
			background-color:#fff;
		}

	</style>
</head>
<body>
	<div class="box">
		<h3>地区</h3>
		<div id="area">
		</div>
		<h3>产品</h3>
		<div id="product">
		</div>
		<div id="table-wrapper">
		</div>
	</div>
	<script src="ife31data.js"></script>
	<script>
		var tableWrapper = document.querySelector('#table-wrapper');
		var area = document.querySelector('#area');
		var areaBtn = area.getElementsByTagName('input');
		var product = document.querySelector('#product');
		var productBtn = product.getElementsByTagName('input');
		var selectedProduct = [];
		var selectedArea = [];
		var clickedBtns = {
			area: {
				'华北': true,
				'华南': false,
				'华东': false
			},
			product: {
				'手机': true,
				'笔记本': false,
				'智能音箱': false
			}
		};
		var areaArr = [{name:'area', value:'huabei', text:'华北'},
			{name:'area', value:'huanan', text:'华南'},
			{name:'area', value:'huadong', text:'华东'},
			{name:'area', value:'all', text:'全选'}];

		var productArr = [{name:'prodcut', value:'mobile', text:'手机'},
			{name:'product', value:'laptop', text:'笔记本'},
			{name:'product', value:'speaker', text:'智能音箱'},
			{name:'product', value:'all', text:'全选'}];
		var selectionNumber = 0;
		generateCheckboxs(area,areaArr);
		generateCheckboxs(product,productArr);
		addToTable();

		area.addEventListener('click',function () {
			var ev = ev || window.event;
			var target = ev.target || ev.srcElement;
			if (target.nodeName.toLowerCase() === 'input') {
				switch (target.value) {
					case 'huabei':
						clickedItems('area','华北',target);
						break;
					case 'huanan':
						clickedItems('area','华南',target);
						break;
					case 'huadong':
						clickedItems('area','华东',target);
						break;
					case 'all':
						if (target.checked){
							checkAll(areaBtn);
						} else{
							uncheckAll(areaBtn);
						}
						break;
					default:
						break;
				}
				if (checkSelectedAll(areaBtn)){
					checkAll(areaBtn);
				}
				addToTable();
			}
		})

		product.addEventListener('click',function () {
			var ev = ev || window.event;
			var target = ev.target || ev.srcElement;
			if (target.nodeName.toLowerCase() === 'input'){
					switch (target.value){
						case 'mobile':
							clickedItems('product','手机',target);
							break;
						case 'laptop':
							clickedItems('product','笔记本',target);
							break;
						case 'speaker':
							clickedItems('product','智能音箱',target);
							break;
						case 'all':
							if (target.checked){
								checkAll(productBtn);
							} else{
								uncheckAll(productBtn);
							}
							break;
						default:
							break;
					}
				if (checkSelectedAll(productBtn)) checkAll(productBtn);
				addToTable();
			}
		})

		function getSelectedBtns() {
			// 获取area中选中的选项
			for (var i in clickedBtns.area) {
				if (clickedBtns.area[i]) {
					if (selectedArea.indexOf(i) < 0){
						selectedArea.push(i);
					}

				}else{
					if (selectedArea.indexOf(i) >= 0){
						selectedArea.splice(selectedArea.indexOf(i), 1);
					}
				}
			}
			// 获取product中选中的选项
			for (var i in clickedBtns.product){
				if (clickedBtns.product[i]) {
					if (selectedProduct.indexOf(i) < 0){
						selectedProduct.push(i);
					}
				}else{
					if (selectedProduct.indexOf(i) >= 0){
						selectedProduct.splice(selectedProduct.indexOf(i), 1);
					}
				}
			}
		}

		function checkLastSelection(type) {
			selectionNumber = 0;
			for (var i = 0 ; i < type.length; i++){
				if (type[i].value !== 'all'){
					if (type[i].checked) selectionNumber += 1;
				}
			}
			return selectionNumber < 1;
		}

		function clickedItems(type, targetValue, target) {
			if (type === 'area'){
				if (checkLastSelection(areaBtn))  target.checked = true;
				if (target.checked){
					clickedBtns.area[targetValue] = true;
				}else {
					clickedBtns.area[targetValue] = false;
				}
			}else {
				if (checkLastSelection(productBtn)) target.checked = true;
				if (target.checked) {
					clickedBtns.product[targetValue] = true;
				} else{
					clickedBtns.product[targetValue] = false;
				}
			}
		}

		function checkAllItems(obj) {
			if (obj === areaBtn){
				for (var i in clickedBtns.area){
					clickedBtns.area[i] = true;
				}
			} else{
				for (var i in clickedBtns.product){
					clickedBtns.product[i] = true;
				}
			}
		}

		function uncheckAllItems(obj) {
			if (obj === areaBtn){
				for (var i in clickedBtns.area){
					clickedBtns.area[i] = i === '华北';
				}
			} else{
				for (var i  in clickedBtns.product){
					clickedBtns.product[i] = i === '手机';
				}
			}
		}

		function checkAll(obj) {
			for (var i = 0; i < obj.length; i++){
				obj[i].checked = true;
			}
			checkAllItems(obj);
		}

		function uncheckAll(obj) {
			selectionNumber = 0;
			for (var i = 1; i < obj.length; i++){
				obj[i].checked = false;
			}
			uncheckAllItems(obj);
		}

		function checkSelectedAll(obj){
			for (var i = 0; i < obj.length; i++){
				if (i === 3){
					break;
				}

				if (!obj[i].checked){
					obj[3].checked = false;
					return false;
				}
			}
			return true;
		}

		function addToTable() {
			getSelectedBtns();
			var str = '';
			var table = '<table class="dataintable"><tr><th>商品</th><th>地区</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th></tr>';
			var combineFactor = 'productArea';
			var arrL = [selectedArea.length,selectedProduct.length];
			if (arrL[0] === 0 && arrL[1] === 0){
				return tableWrapper.innerHTML = '';
			} else {
				for (var i in sourceData){
					switch(arrL.join('').replace(/[2-999]/g, 'm')){
						case '11':
							str += tableStr('productArea', sourceData[i]);
							break;
						case '1m':
							table = '<table class="dataintable"><tr><th>地区</th><th>商品</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th></tr>';
							str += tableStr('areaProduct', sourceData[i]);
							combineFactor = 'areaProduct';
							break;
						case 'm1':
							str += tableStr('productArea', sourceData[i]);
							break;
						case 'mm':
							str += tableStr('productArea', sourceData[i]);
							break;
						default:
							break;

					}
				}
				table += str;
				tableWrapper.innerHTML = table + '</table>';
				return combineTable(combineFactor);
			}
		}

		function tableStr(order, obj) {
			var str = '',
				product = obj.product,
				sale = obj.sale,
				region = obj.region;
			if (selectedArea.indexOf(region) >= 0 && selectedProduct.indexOf(product) >= 0){
				switch (order){
					case 'productArea':
						str += '<tr><td class="header">'+product+'</td><td>'+region+'</td><td>'+sale[0]+'</td><td>'+sale[1]+'</td><td>'+sale[2]+'</td><td>'+sale[3]+'</td><td>'+sale[4]+'</td><td>'+sale[5]+'</td><td>'+sale[6]+'</td><td>'+sale[7]+'</td><td>'+sale[8]+'</td><td>'+sale[9]+'</td><td>'+sale[10]+'</td><td>'+sale[11]+'</td></tr>';
						break;
					case'areaProduct':
						str += '<tr><td class="header">'+region+'</td><td>'+product+'</td><td>'+sale[0]+'</td><td>'+sale[1]+'</td><td>'+sale[2]+'</td><td>'+sale[3]+'</td><td>'+sale[4]+'</td><td>'+sale[5]+'</td><td>'+sale[6]+'</td><td>'+sale[7]+'</td><td>'+sale[8]+'</td><td>'+sale[9]+'</td><td>'+sale[10]+'</td><td>'+sale[11]+'</td></tr>';
						break;
					default:
						break;
				}
			}
			return str;
		}

		function combineTable(combineFactor) {
			var head = document.querySelectorAll('.header');
			var productL = selectedProduct.length;
			var areaL = selectedArea.length;
			var totalRows = productL * areaL;
			var element = combineFactor === 'productArea' ? areaL : productL;
			var length = combineFactor === 'productArea' ? productL : areaL;
			var arr = [];
			for (var i = 0; i < length; i++){
				arr.push(element * i);
			}

			for (var i = 0; i < totalRows; i++){
				if (arr.indexOf(i) >= 0){
					head[i].setAttribute('rowspan', element.toString());
				}else{
					head[i].style.display = 'none';
				}
			}
		}

		function generateCheckboxs(parent, checkbox) {
			var innerCheckbox= '';
			for (var i in checkbox){
				var check = i === '0' ? 'checked=checked': '';
				innerCheckbox += '<input type=checkbox name='+checkbox[i].name+' value='+checkbox[i].value+' '+check+' />'+checkbox[i].text+' ';
			}
			parent.innerHTML = innerCheckbox;
		}

	</script>
</body>
</html>